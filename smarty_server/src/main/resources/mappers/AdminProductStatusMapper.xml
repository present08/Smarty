<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.green.smarty.mapper.AdminProductStatusMapper">

    <insert id="insertProductStatus" parameterType="com.green.smarty.vo.ProductStatusVO" useGeneratedKeys="true" keyProperty="status_id">
        INSERT INTO product_status (status_id, product_id, current_status, updated_at)
        VALUES (#{status_id}, #{product_id}, #{current_status}, CURRENT_TIMESTAMP)
    </insert>

    <select id="findProductStatusByFacility" parameterType="string" resultType="map">
        SELECT
        ps.status_id,
        ps.product_id,
        ps.current_status,
        ps.changed_status,
        ps.change_quantity,
        ps.updated_at,
        p.product_name,
        p.size,
        CASE
        WHEN ps.status_id LIKE '%Ind%' THEN 1
        ELSE p.stock
        END AS stock
        FROM product_status ps
        JOIN product p ON ps.product_id = p.product_id
        WHERE p.facility_id = #{facilityId}
    </select>

    <select id="getAllProductStatuses" resultType="com.green.smarty.vo.ProductStatusVO">
        SELECT * FROM product_status;
    </select>

    <select id="selectStatusByProductId" parameterType="string" resultType="com.green.smarty.vo.ProductStatusVO">
        SELECT * FROM product_status WHERE product_id = #{product_id}
    </select>

    <update id="updateProductStatus" parameterType="map">
        UPDATE product_status
        SET product_status = #{product_status}, updated_at = CURRENT_TIMESTAMP
        WHERE status_id = #{status_id}
    </update>

    <!-- stock 업데이트 -->
    <update id="updateProductStock" parameterType="map">
        UPDATE product
        SET stock = #{stock}
        WHERE product_id = #{product_id};
    </update>

    <!-- updated_at 업데이트 -->
    <update id="updateProductStatusUpdatedAt" parameterType="map">
        UPDATE product_status
        SET updated_at = CURRENT_TIMESTAMP
        WHERE product_id = #{product_id};
    </update>

    <select id="findMaxSuffix" parameterType="string" resultType="int">
        SELECT COALESCE(MAX(CAST(SUBSTRING(status_id, LENGTH(#{baseId}) + 1) AS UNSIGNED)), 0)
        FROM product_status
        WHERE status_id LIKE CONCAT(#{baseId}, '%')
    </select>

    <select id="existsByStatusId" parameterType="string" resultType="boolean">
        SELECT COUNT(*) > 0 FROM product_status WHERE status_id = #{status_id}
    </select>

    <!-- 상태 ID로 현재 상태 및 수량 조회 -->
    <select id="getProductInfoByStatusId" resultType="map">
        SELECT
        ps.status_id,
        ps.current_status,
        ps.changed_status,
        ps.change_quantity,
        p.product_id,
        p.stock
        FROM product_status ps
        JOIN product p ON ps.product_id = p.product_id
        WHERE ps.status_id = #{status_id};
    </select>

    <!-- 변경된 상태 업데이트 -->
    <update id="updateChangedStatus" parameterType="map">
        UPDATE product_status
        SET changed_status = #{changedStatus},
        change_quantity = #{quantity},
        updated_at = CURRENT_TIMESTAMP
        WHERE status_id = #{statusId}
    </update>

    <!-- 상태 복구 -->
    <update id="restoreToAvailable" parameterType="string">
        UPDATE product_status
        SET changed_status = NULL,
        change_quantity = 0,
        updated_at = CURRENT_TIMESTAMP
        WHERE status_id = #{statusId}
    </update>

    <!-- 특정 Product의 상태별 수량 조회 -->
    <select id="findStatusCountsByProductId" parameterType="string" resultType="map">
        SELECT
        ps.changed_status,
        SUM(ps.change_quantity) AS total_quantity
        FROM product_status ps
        WHERE ps.product_id = #{productId}
        GROUP BY ps.changed_status
    </select>

</mapper>
