<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.green.smarty.mapper.UserCouponMapper">

<!--    1. 첫 회원가입 시 쿠폰발급-->
<!--    2. 이미 발급된 쿠폰이 있는지 체크하기 boolean -> 쿠폰이 있는지 여부를 true 또는 false로 반환
            true면 x false 반환-->
<!--    3. 쿠폰 사용시 상태 변경 : 쿠폰이 사용되면 상태를 'ISSUED(발급된)'에서 'USED(사용됨)' 변경 -->
<!--    4. 기간내 사용하지 않으면 자동으로 상태 변경 (발급 후 일년이내) : 더 생각하고 구현해보기 -->

<!--    회원가입시 쿠폰 발급 쿼리문-->
    <insert id="InsertUserNewCoupon" parameterType="com.green.smarty.vo.CouponVO">
        INSERT INTO conpon (coupon_id,coupon_code,coupon_name,issue_date,expiry_date,user_id,status)
        VALUES (#{coupon_id}, #{coupon_code}, #{coupon_name},#{issue_date},#{expiry_date},#{user_id},#{status})
    </insert>

<!--    이미 발급을 받았는지 체크 (중복체크)-->
    <select id="CheckExistingCoupon" resultType="boolean" parameterType="String">
        SELECT COUNT (*) > 0
        FROM coupon
        WHERE user_id = #{user_id} AND status = 'ISSUED'
    </select>

<!--    쿠폰 사용하면 상태 바뀜 ex: ISSUED > USED -->
    <update id="UserCouponStatus" parameterType="com.green.smarty.vo.CouponVO">
        UPDATE coupon
        SET status = 'USED', issue_date = NOW()
        WHERE coupon_id = #{coupon_id} AND user_id = #{user_id} AND status = 'ISSUED';
    </update>

<!--    발급 상태에서 1년이 지나면 자동으로 폐기 아직 구현 x-->
<!--    <update id="expireUnusedCoupons" parameterType="String">-->
<!--        UPDATE user_coupon-->
<!--        SET status = 'EXPIRED'-->
<!--        WHERE issue_date < DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 1 YEAR)-->
<!--        AND status = 'ISSUED'-->
<!--        AND (expiry_date < CURRENT_TIMESTAMP OR expiry_date IS NULL)-->
<!--    </update>-->

</mapper>