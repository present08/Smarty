<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.green.smarty.mapper.UserLoginHistoryMapper">

    <!-- 로그인 성공 기록 삽입 -->
    <insert id="insertLoginHistory" parameterType="com.green.smarty.vo.LoginHistoryVO">
        INSERT INTO login_history (user_id, login_time, ip_address, login_status, user_agent)
        VALUES (#{user_id}, NOW(), #{ip_address}, #{login_status}, #{user_agent})
    </insert>

    <!-- 로그인 실패 기록 삽입 -->
    <insert id="insertLoginFailureHistory" parameterType="com.green.smarty.vo.LoginHistoryVO">
        INSERT INTO login_history (user_id, login_time, ip_address, login_status, user_agent)
        VALUES (#{user_id}, NOW(), #{ip_address}, 'FAILURE', #{user_agent})
    </insert>

    <!-- 로그아웃 시간 업데이트 -->
    <update id="updateLogoutTime" parameterType="com.green.smarty.vo.LoginHistoryVO">
        UPDATE login_history
        SET logout_time = NOW()
        WHERE user_id = #{user_id} AND logout_time IS NULL
    </update>

    <!--    login_history 테이블에 값을 insert 하거나 update 하는 쿼리문임 값을 0으로 바꿔주는거임
만약 기간이 마감되기 전에 로그인 해버리거나 그러면 다시 3개월되기 일주일 전을 세야하기 때문에 0으로 초기화시킴-->
    <insert id="insertOrUpdateSentHumanMessageByUserId" parameterType="String">
        INSERT INTO login_history (user_id, sent_human_message)
        VALUES (#{user_id}, FALSE)
        ON DUPLICATE KEY UPDATE
        sent_human_message = FALSE;
    </insert>


    <insert id="upsertSentHumanMessageBasedOnUser" parameterType="String">
        INSERT INTO login_history (user_id, sent_human_message)
        SELECT u.user_id, 0
        FROM user u
        WHERE DATE_SUB(DATE_ADD(u.login_date, INTERVAL 3 MONTH), INTERVAL 7 DAY) &lt;= CURDATE()
        ON DUPLICATE KEY UPDATE
        sent_human_message = 0;
    </insert>

</mapper>
